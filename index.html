<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Livefy - Channel Grid Player (Fixed)</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      margin: 0;
      background-color: #202020;
      color: #ecf0f1;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .top-section {
      background-color: #34495e;
      padding: 10px 20px;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    #status {
      padding: 5px 10px;
      background: #3498db;
      border-radius: 4px;
      display: inline-block;
    }
    #video-container {
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
    }
    video {
      width: 100%;
      border-radius: 6px;
      background: #000;
      min-height: 250px;
    }
    .main-container {
      max-width: 1200px;
      margin: auto;
      padding: 10px;
    }
    .channel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
    .channel-item {
      background: #000;
      border: 2px solid #3498db;
      border-radius: 8px;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .channel-item:hover {
      transform: scale(1.05);
      border-color: #2ecc71;
    }
    .channel-item.active {
      border-color: #e74c3c;
      box-shadow: 0 0 15px rgba(231, 76, 60, 0.7);
    }
    .channel-name { font-weight: bold; margin-top: 5px; }
  </style>
</head>
<body>

  <div class="top-section">
    <h1>üì∫ Live Channel Viewer</h1>
    <div id="status">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    <div id="video-container">
      <video id="video" controls autoplay playsinline></video>
    </div>
  </div>

  <div class="main-container">
    <div class="channel-grid" id="channel-list">
      <p style="grid-column: 1 / -1; text-align: center;">‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>
    <div id="total-count" style="text-align:center;margin-top:10px;color:#7f8c8d;"></div>
  </div>

  <script>
    const M3U_URL = "https://bongoflixbd.top/test/playlist.php";

    const PROXIES = [
      { name: "Fringe", prefix: "https://cors-proxy.fringe.zone/", needsEncode: false },
      { name: "AllOrigins", prefix: "https://api.allorigins.win/raw?url=", needsEncode: true }
    ];

    const TEST_STREAM = "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8"; // fallback video

    let currentHls = null;
    let lastItem = null;
    let activeProxyIndex = 0;

    function playStream(streamUrl, channelItem) {
      const video = document.getElementById("video");
      const status = document.getElementById("status");

      if (lastItem) lastItem.classList.remove("active");
      if (channelItem) {
        channelItem.classList.add("active");
        lastItem = channelItem;
      }

      const proxy = PROXIES[activeProxyIndex];
      let finalUrl = proxy.needsEncode
        ? proxy.prefix + encodeURIComponent(streamUrl)
        : proxy.prefix + streamUrl;

      status.textContent = "üîÑ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
      status.style.background = "#f39c12";

      if (Hls.isSupported()) {
        if (currentHls) currentHls.destroy();
        currentHls = new Hls();
        currentHls.loadSource(finalUrl);
        currentHls.attachMedia(video);
        currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play().catch(() => {
            status.textContent = "‚ö†Ô∏è Autoplay ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‚Äî ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
            status.style.background = "#e67e22";
          });
        });
        currentHls.on(Hls.Events.ERROR, (e, data) => {
          console.error("HLS Error:", data);
          status.textContent = "‚ùå ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
          status.style.background = "#e74c3c";
        });
        video.onplaying = () => {
          status.textContent = "‚úÖ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ö‡¶≤‡¶õ‡ßá...";
          status.style.background = "#2ecc71";
        };
        video.onwaiting = () => {
          status.textContent = "‚è≥ ‡¶¨‡¶æ‡¶´‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
          status.style.background = "#f1c40f";
        };
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = finalUrl;
        video.play();
      } else {
        status.textContent = "‚ùå HLS ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡¶Ø‡¶º‡•§";
        status.style.background = "#e74c3c";
      }
    }

    async function loadM3U(proxyIndex = 0) {
      const list = document.getElementById("channel-list");
      const status = document.getElementById("status");

      if (proxyIndex >= PROXIES.length) {
        status.textContent = "‚ö†Ô∏è ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‚Äî fallback stream ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§";
        status.style.background = "#e74c3c";
        playStream(TEST_STREAM, null);
        return;
      }

      const proxy = PROXIES[proxyIndex];
      activeProxyIndex = proxyIndex;

      let url = proxy.needsEncode
        ? proxy.prefix + encodeURIComponent(M3U_URL)
        : proxy.prefix + M3U_URL;

      status.textContent = `M3U ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... (${proxy.name})`;
      status.style.background = "#3498db";

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø");
        const text = await res.text();
        parseM3U(text);
      } catch (err) {
        console.warn(`Proxy ${proxy.name} ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•`, err);
        loadM3U(proxyIndex + 1);
      }
    }

    function parseM3U(data) {
      const lines = data.split("\n").map(l => l.trim()).filter(l => l);
      const streams = [];
      let current = null;
      let count = 0;

      for (const line of lines) {
        if (line.startsWith("#EXTINF:")) {
          current = {};
          const name = line.split(",").pop().trim();
          const groupMatch = line.match(/group-title="([^"]+)"/);
          current.name = name || "Unknown";
          current.group = groupMatch ? groupMatch[1] : "General";
        } else if (current && !line.startsWith("#")) {
          current.url = line;
          streams.push(current);
          current = null;
          count++;
        }
      }
      displayStreams(streams, count);
    }

    function displayStreams(streams, total) {
      const list = document.getElementById("channel-list");
      const status = document.getElementById("status");
      const totalDiv = document.getElementById("total-count");

      if (!streams.length) {
        status.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
        status.style.background = "#e74c3c";
        return;
      }

      totalDiv.textContent = `‡¶Æ‡ßã‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤: ${total} (Proxy: ${PROXIES[activeProxyIndex].name})`;
      status.textContent = "‚úÖ ‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‚Äî ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
      status.style.background = "#2ecc71";

      let html = "";
      const grouped = {};
      streams.forEach(s => {
        if (!grouped[s.group]) grouped[s.group] = [];
        grouped[s.group].push(s);
      });

      Object.keys(grouped).forEach(group => {
        html += `<div style="grid-column:1/-1;color:#3498db;font-weight:bold;border-bottom:1px solid #3498db;margin-top:10px;">${group}</div>`;
        grouped[group].forEach(s => {
          html += `
            <div class="channel-item" onclick="playStream('${s.url}', this)">
              <span style="font-size:2em;color:#2ecc71;">‚ñ∂Ô∏è</span>
              <div class="channel-name">${s.name}</div>
            </div>
          `;
        });
      });
      list.innerHTML = html;
    }

    document.addEventListener("DOMContentLoaded", () => loadM3U());
  </script>
</body>
</html>
